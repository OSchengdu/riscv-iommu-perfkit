
### **一、必选交付物（核心要求）**
#### **1. HPM 硬件性能监控测试**
| **产出项**               | **具体要求**                                                                 | **验收标准**                                                                 |
|--------------------------|-----------------------------------------------------------------------------|-----------------------------------------------------------------------------|
| **1.1 HPM 测试代码**     | - 实现 `perf` 工具对 RISC-V IOMMU PMU 事件的采集（计数/采样模式）<br>- 包含基础事件测试用例（如 `iommu_requests`, `iotlb_hit`） | 能在 QEMU 中通过 `perf stat -e riscv_iommu/*/` 获取有效数据                  |
| **1.2 构建文档**         | - 详细的内核编译步骤（含 HPM 补丁应用方法）<br>- RootFS 制作和 `perf` 移植说明       | 其他开发者可复现环境                                                         |
| **1.3 测试报告**         | - 性能基线数据（如 TLB 命中率、DMA 延迟）<br>- 与 x86/ARM 的 IOMMU PMU 数据对比       | 包含可量化的性能结论                                                         |

#### **2. 基础测试脚本**
| **产出项**               | **具体要求**                                                                 |
|--------------------------|-----------------------------------------------------------------------------|
| **2.1 QEMU 启动脚本**    | 自动化启动带 IOMMU 支持的 QEMU-RISCV 环境（标准 `virt` 机器即可）             |
| **2.2 测试用例脚本**     | 一键运行所有 HPM 测试（如 `./run_hpm_tests.sh`）                             |

---

### **二、拓展**
#### **1. 嵌套 IOMMU 测试**
| **产出项**               | **具体要求**                                                                 |
|--------------------------|-----------------------------------------------------------------------------|
| **1.1 嵌套映射测试代码** | 验证两阶段地址转换（GVA→GPA→HPA）和 `iotlb_sync_map` 的触发逻辑               |
| **1.2 异常测试用例**     | 模拟客户机页表修改后的 TLB 一致性验证                                         |

#### **2. 高级 QEMU 功能**
| **产出项**               | **具体要求**                                                                 |
|--------------------------|-----------------------------------------------------------------------------|
| **2.1 AIA 中断支持**     | 在 QEMU 中启用 `aia=aplic-imsic` 测试中断驱动的 HPM 事件                      |
| **2.2 多设备 DMA 测试**  | 模拟多设备并发访问时的 IOMMU 隔离性                                           |

---

### **三、交付物形式**
#### **代码仓库结构示例**
```text
deliverables/
├── docs/
│   ├── BUILD.md              # 环境构建文档
│   └── HPM_TEST_RESULTS.md   # 性能测试报告
├── scripts/
│   ├── setup_qemu.sh         # QEMU 环境配置
│   └── run_hpm_tests.sh      # 自动化测试入口
├── src/
│   ├── hpm/                  # HPM 测试代码
│   └── nested/               # 嵌套测试代码（拓展）
└── README.md                 # 项目总说明
```

